<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>병원 시간별 일정 | DOC-LINK</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Noto+Sans+KR:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            overflow: hidden;
        }

        @media (max-width: 768px) {
            body {
                overflow: auto;
            }

            .timeline-container {
                height: auto;
                min-height: 100vh;
                padding: 90px 4% 20px;
            }

            .timeline-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .doctor-schedule-grid {
                gap: 15px;
            }

            .doctor-timeline {
                padding: 20px 15px;
            }

            .timeline-hours {
                grid-template-columns: 50px 1fr !important;
            }

            .hour-label {
                font-size: 0.7rem !important;
                padding: 10px 8px 10px 0 !important;
            }
        }

        .timeline-container {
            height: 100vh;
            padding: 80px 2% 20px;
            display: flex;
            flex-direction: column;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 1%;
        }

        .timeline-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .timeline-wrapper {
            flex: 1;
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 30px;
            overflow-y: auto;
        }

        .selected-date {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .doctor-schedule-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .doctor-timeline {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--glass-border);
        }

        .doctor-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .doctor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .doctor-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .doctor-specialty {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        .timeline-hours {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 15px;
        }

        .timeline-hour-row {
            display: contents;
        }

        .hour-label {
            font-size: 0.9rem;
            color: var(--text-sub);
            font-weight: 600;
            text-align: right;
            padding: 12px 15px 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .hour-slots {
            display: grid;
            grid-template-columns: repeat(48, 1fr);
            gap: 2px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            min-height: 50px;
            padding: 5px 0;
        }

        .time-slot {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .time-slot:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .time-slot.has-event {
            background: var(--primary-btn);
            color: #fff;
            cursor: pointer;
        }

        .time-slot.confirmed {
            background: #28a745;
        }

        .time-slot.pending {
            background: #ffc107;
        }

        .time-slot.recruiting {
            background: #17a2b8;
        }

        .event-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: 0.2s;
        }

        .time-slot.has-event:hover .event-tooltip {
            opacity: 1;
        }

        .legend {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .conflict-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="ambient-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <nav>
        <a href="index.html" class="logo">DOC-LINK</a>
        <div class="nav-links">
            <a href="hospital-dashboard.html">대시보드</a>
            <a href="hospital-profile.html">프로필</a>
            <a href="#" onclick="logoutHandler()">로그아웃</a>
        </div>
    </nav>

    <div class="timeline-container">
        <div class="timeline-header">
            <h1>전체 의사 시간별 일정</h1>
            <div class="date-navigation">
                <button onclick="prevDay()" style="padding: 10px 15px; background: rgba(255, 255, 255, 0.6); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer;"><i class="fa-solid fa-chevron-left"></i> 이전</button>
                <button onclick="goToToday()" style="padding: 10px 15px; background: rgba(255, 255, 255, 0.6); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer;">오늘</button>
                <button onclick="nextDay()" style="padding: 10px 15px; background: rgba(255, 255, 255, 0.6); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer;">다음 <i class="fa-solid fa-chevron-right"></i></button>
                <a href="hospital-dashboard.html" class="btn btn-secondary btn-small">달력으로</a>
            </div>
        </div>

        <div class="timeline-wrapper">
            <div class="selected-date" id="selectedDate">2025년 1월 12일 (수)</div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #28a745;"></div>
                    <span>확정됨</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc107;"></div>
                    <span>승인 대기</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #17a2b8;"></div>
                    <span>모집 중</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--primary-btn);"></div>
                    <span>일반 일정</span>
                </div>
            </div>

            <div id="conflictWarnings"></div>

            <div class="doctor-schedule-grid" id="doctorSchedules">
                <!-- 의사별 타임라인은 JS로 생성 -->
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth('hospital');
            
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');
            if (dateParam) {
                const [year, month, day] = dateParam.split('-');
                currentDate = new Date(year, month - 1, day);
            }
            renderTimeline();
        });

        let currentDate = new Date(2025, 0, 12);

        // 샘플 데이터 - 의사별 일정
        const doctorSchedules = {
            '2025-01-12': {
                '김의사': [
                    { start: '13:00', end: '18:00', type: 'recruiting', note: '내과 대진 - 모집중 (3명 신청)' }
                ],
                '박의사': [
                    { start: '09:00', end: '17:00', type: 'confirmed', note: '내과 대진 - 확정' }
                ]
            },
            '2025-01-15': {
                '김의사': [],
                '박의사': [],
                '이의사': [
                    { start: '09:00', end: '13:00', type: 'recruiting', note: '정형외과 대진 - 모집중 (1명 신청)' }
                ]
            }
        };

        function formatDate(date) {
            const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${year}년 ${month}월 ${day}일 (${weekday})`;
        }

        function formatDateForUrl(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function renderTimeline() {
            document.getElementById('selectedDate').textContent = formatDate(currentDate);
            
            const dateKey = formatDateForUrl(currentDate);
            const schedules = doctorSchedules[dateKey] || {};
            
            const container = document.getElementById('doctorSchedules');
            container.innerHTML = '';

            // 모든 의사 목록
            const allDoctors = ['김의사', '박의사', '이의사'];
            const conflicts = [];

            allDoctors.forEach(doctor => {
                const doctorDiv = document.createElement('div');
                doctorDiv.className = 'doctor-timeline';

                const header = document.createElement('div');
                header.className = 'doctor-header';
                header.innerHTML = `
                    <div class="doctor-avatar">
                        <i class="fa-solid fa-user-doctor"></i>
                    </div>
                    <div>
                        <div class="doctor-name">${doctor}</div>
                        <div class="doctor-specialty">${doctor === '김의사' ? '내과' : doctor === '박의사' ? '내과' : '정형외과'} 전문의</div>
                    </div>
                `;
                doctorDiv.appendChild(header);

                const timelineDiv = document.createElement('div');
                timelineDiv.className = 'timeline-hours';

                const doctorEvents = schedules[doctor] || [];

                // 00:00부터 23:30까지 30분 단위
                for (let hour = 0; hour < 24; hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                        
                        const hourRow = document.createElement('div');
                        hourRow.className = 'timeline-hour-row';

                        const label = document.createElement('div');
                        label.className = 'hour-label';
                        if (minute === 0) {
                            label.textContent = `${String(hour).padStart(2, '0')}:00`;
                        } else {
                            label.textContent = '';
                        }
                        hourRow.appendChild(label);

                        const slots = document.createElement('div');
                        slots.className = 'hour-slots';

                        // 해당 시간에 일정이 있는지 확인
                        const event = doctorEvents.find(e => {
                            const [startH, startM] = e.start.split(':').map(Number);
                            const [endH, endM] = e.end.split(':').map(Number);
                            const eventStart = startH * 60 + startM;
                            const eventEnd = endH * 60 + endM;
                            const current = hour * 60 + minute;
                            return current >= eventStart && current < eventEnd;
                        });

                        const slot = document.createElement('div');
                        slot.className = 'time-slot';
                        
                        if (event) {
                            slot.classList.add('has-event', event.type);
                            slot.style.gridColumn = 'span 1';
                            
                            const tooltip = document.createElement('div');
                            tooltip.className = 'event-tooltip';
                            tooltip.textContent = event.note;
                            slot.appendChild(tooltip);

                            slot.onclick = () => {
                                alert(`${doctor}님의 일정\n${event.note}\n시간: ${event.start} - ${event.end}`);
                            };

                            // 중복 체크 (다른 의사와 같은 시간대)
                            const otherDoctors = allDoctors.filter(d => d !== doctor);
                            otherDoctors.forEach(otherDoc => {
                                const otherEvents = schedules[otherDoc] || [];
                                const hasConflict = otherEvents.some(e => {
                                    return (e.start === event.start && e.end === event.end);
                                });
                                if (hasConflict && event.type === 'confirmed') {
                                    conflicts.push({
                                        doctor,
                                        time: `${event.start} - ${event.end}`,
                                        note: event.note
                                    });
                                }
                            });
                        } else {
                            slot.onclick = () => {
                                // 일정 추가 기능
                            };
                        }

                        slots.appendChild(slot);
                        hourRow.appendChild(slots);
                        timelineDiv.appendChild(hourRow);
                    }
                }

                doctorDiv.appendChild(timelineDiv);
                container.appendChild(doctorDiv);
            });

            // 중복 경고 표시
            const warningsContainer = document.getElementById('conflictWarnings');
            if (conflicts.length > 0) {
                warningsContainer.innerHTML = `
                    <div class="conflict-warning">
                        <i class="fa-solid fa-exclamation-triangle"></i> <strong>중복 부킹 경고:</strong> 
                        ${conflicts.length}건의 시간대 중복이 감지되었습니다. 확인해주세요.
                    </div>
                `;
            } else {
                warningsContainer.innerHTML = '';
            }
        }

        function prevDay() {
            currentDate.setDate(currentDate.getDate() - 1);
            renderTimeline();
            updateUrl();
        }

        function nextDay() {
            currentDate.setDate(currentDate.getDate() + 1);
            renderTimeline();
            updateUrl();
        }

        function goToToday() {
            currentDate = new Date();
            renderTimeline();
            updateUrl();
        }

        function updateUrl() {
            const dateStr = formatDateForUrl(currentDate);
            window.history.replaceState({}, '', `hospital-timeline.html?date=${dateStr}`);
        }

        function logoutHandler() {
            if (confirm('로그아웃하시겠습니까?')) {
                logout();
            }
        }
    </script>
</body>
</html>